name: Build PHP 8.3 for AquaMarine

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential autoconf bison re2c \
          libxml2-dev libssl-dev libcurl4-openssl-dev \
          libyaml-dev libzip-dev zlib1g-dev \
          libsqlite3-dev pkg-config

    - name: Download PHP 8.3
      run: |
        wget https://www.php.net/distributions/php-8.3.2.tar.gz
        tar -xzf php-8.3.2.tar.gz

    - name: Download pthreads (patched)
      run: |
        git clone https://github.com/krakjoe/pthreads.git

    - name: Build PHP
      run: |
        cd php-8.3.2

        ./buildconf --force

        ./configure \
          --prefix=$PWD/build \
          --enable-cli \
          --enable-phar \
          --enable-sockets \
          --enable-opcache \
          --with-zlib \
          --with-curl \
          --with-openssl \
          --with-yaml \
          --disable-cgi \
          --disable-fpm \
          --without-pear

        make -j$(nproc)
        make install

    - name: Build pthreads
      run: |
        cd pthreads
        ../php-8.3.2/build/bin/phpize
        ./configure --with-php-config=../php-8.3.2/build/bin/php-config
        make -j$(nproc)
        make install

    - name: Verify extensions
      run: |
        php-8.3.2/build/bin/php -m

    - name: Upload PHP build
      uses: actions/upload-artifact@v4
      with:
        name: php-8.3-aquamarine
        path: php-8.3.2/build
